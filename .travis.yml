language: rust
cache: cargo
matrix:
  include:
    - os: osx
      rust: stable
      env: TARGET=x86_64-apple-darwin

before_install:
  - ci/before_install.bash

env:
  global:
    - HOST=x86_64-unknown-linux-gnu

install:
  - if [[ $TRAVIS_OS_NAME = linux && $HOST != $TARGET ]]; then rustup target add $TARGET; fi

script:
  - ci/script.bash

before_deploy:
  - git config --local user.name "Gabriel Barker"
  - git config --local user.email "$GITHUB_EMAIL"
  - name="clyp-test-release"
  - git tag $name
  - mkdir $name
  - cp target/$TARGET/release/clyp $name/
  - cp README.md LICENSE $name/
  - tar czvf $name.tar.gz $name

deploy:
  provider: releases
  api_key: *GITHUB_TOKEN
  file: clyp-test-release.tar.gz
  skip_cleanup: true
  draft: true
  on:
    branch: master
    tags: true
